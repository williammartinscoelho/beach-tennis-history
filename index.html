<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Beach Tennis Cloud</title>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary: #FF9F1C;   
            --secondary: #2EC4B6; 
            --bg-dark: #121212;   
            --bg-card: #1E1E1E;   
            --text-light: #E0E0E0;
            --text-muted: #A0A0A0;
            --danger: #E71D36;
            --warning: #FFB703;
            --success: #06D6A0;
            --nav-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark); color: var(--text-light);
            margin: 0; padding: 0; touch-action: manipulation; user-select: none; 
            padding-bottom: var(--nav-height);
        }

        .app-container { max-width: 100%; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* Loading Overlay */
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Header com Login */
        header {
            background-color: var(--bg-card); padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333;
        }
        .header-title { font-weight: 600; font-size: 1.1rem; }
        .auth-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; }

        /* Login Modal & Inputs */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        .modal-card {
            background: var(--bg-card); padding: 25px; border-radius: 15px;
            width: 100%; max-width: 350px; border: 1px solid #444;
        }
        
        /* Password Toggle Style */
        .password-group { position: relative; }
        .password-group input { padding-right: 45px; } /* Espa√ßo para o √≠cone */
        .password-toggle-icon {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            cursor: pointer; font-size: 1.2rem; user-select: none;
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: var(--bg-card); display: flex; justify-content: space-around;
            align-items: center; border-top: 1px solid #333; z-index: 100;
        }
        .nav-item {
            flex: 1; text-align: center; padding: 10px; color: var(--text-muted);
            font-size: 0.7rem; display: flex; flex-direction: column;
            align-items: center; cursor: pointer;
        }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.2rem; margin-bottom: 2px; }

        .screen { padding: 20px; flex: 1; overflow-y: auto; }
        h3 { margin-top: 0; color: var(--primary); }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; }
        input, select {
            width: 100%; padding: 15px; border-radius: 12px;
            border: 1px solid #333; background: var(--bg-card);
            color: var(--text-light); font-size: 1.1rem; outline: none;
        }
        input:focus, select:focus { border-color: var(--primary); }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-size: 1.1rem; font-weight: 700; cursor: pointer;
            transition: transform 0.1s, opacity 0.2s; margin-bottom: 10px;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-primary { background-color: var(--primary); color: #000; }
        .btn-danger { background-color: var(--danger); color: #fff; }
        .btn-warning { background-color: var(--warning); color: #000; }
        .btn-outline { background: transparent; border: 1px solid #555; color: #ccc; }

        .player-list { margin-top: 25px; }
        .player-item {
            background: var(--bg-card); padding: 15px; margin-bottom: 8px;
            border-radius: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .btn-delete { color: var(--danger); padding: 5px 10px; font-weight: bold; cursor: pointer;}

        /* Scoreboard */
        .scoreboard-container { display: flex; flex-direction: column; height: calc(100vh - var(--nav-height) - 60px); }
        .match-header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); padding: 15px; border-radius: 15px; margin-bottom: 15px;
        }
        .score-box { text-align: center; }
        .score-label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; }
        .score-val { font-size: 1.8rem; font-weight: 800; }
        .team-a-color { color: var(--primary); }
        .team-b-color { color: var(--secondary); }
        .undo-bar { margin-bottom: 15px; }
        .points-area { display: flex; flex: 1; gap: 10px; min-height: 0; }
        .team-column {
            flex: 1; display: flex; flex-direction: column; border-radius: 15px;
            overflow: hidden; position: relative;
        }
        .team-a-col { background: rgba(255, 159, 28, 0.15); }
        .team-b-col { background: rgba(46, 196, 182, 0.15); }
        .team-names-overlay {
            padding: 10px; text-align: center; font-size: 0.9rem; font-weight: 600;
            min-height: 50px; display: flex; align-items: center; justify-content: center; line-height: 1.2;
        }
        .big-point-display {
            flex: 2; display: flex; justify-content: center; align-items: center;
            font-size: 7rem; font-weight: 900; line-height: 1; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .btn-point-action {
            flex: 1; border: none; font-size: 1.3rem; font-weight: 800;
            text-transform: uppercase; cursor: pointer; padding: 20px;
        }
        .btn-point-a { background: var(--primary); color: #000; }
        .btn-point-b { background: var(--secondary); color: #000; }
        .btn-point-action:active { filter: brightness(0.9); }

        /* History & Manual Form */
        .history-card {
            background: var(--bg-card); border-radius: 12px; padding: 15px;
            margin-bottom: 15px; border-left: 5px solid #555;
        }
        .history-card.winner-a { border-left-color: var(--primary); }
        .history-card.winner-b { border-left-color: var(--secondary); }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.85rem; color: var(--text-muted); }
        .history-teams { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 600;}
        .history-score-summary {
            background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;
            display: flex; justify-content: space-around; text-align: center;
        }
        .history-final-score { font-size: 1.3rem; font-weight: bold; }
        .manual-form {
            background: #2a2a2a; padding: 15px; border-radius: 12px;
            margin-bottom: 20px; border: 1px solid #444;
        }
        .score-inputs { display: flex; gap: 10px; justify-content: center; }
        .score-input-group { flex: 0 0 80px; text-align: center; }

        /* Stats Table */
        .stats-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .stats-table th { text-align: left; padding: 10px; background: #333; color: var(--text-muted); font-weight: 600; }
        .stats-table td { padding: 12px 10px; border-bottom: 1px solid #333; }
        .stats-table tr:nth-child(even) { background: rgba(255,255,255,0.03); }
        .stats-rank { color: var(--primary); font-weight: bold; width: 30px; }
        .stats-win-rate { font-size: 0.8rem; color: var(--text-muted); }

        /* Login Placeholder */
        .login-placeholder {
            text-align: center; margin-top: 50px; color: var(--text-muted); padding: 20px;
        }
    </style>
</head>
<body>

<div id="app" class="app-container">

    <div class="loading-screen" v-if="loading">
        <div class="spinner"></div>
        <div>A carregar...</div>
    </div>

    <div class="modal-overlay" v-if="showLoginModal">
        <div class="modal-card">
            <h3 style="text-align: center; margin-bottom: 20px;">√Årea Admin</h3>
            <div class="form-group">
                <input type="email" v-model="authEmail" placeholder="E-mail">
            </div>
            
            <div class="form-group password-group">
                <input :type="showPassword ? 'text' : 'password'" v-model="authPassword" placeholder="Senha">
                <span class="password-toggle-icon" @click="showPassword = !showPassword">
                    {{ showPassword ? 'üôà' : 'üëÅÔ∏è' }}
                </span>
            </div>

            <button class="btn btn-primary" @click="login">Entrar</button>
            <button class="btn btn-outline" @click="showLoginModal = false">Cancelar</button>
        </div>
    </div>

    <header v-if="view !== 'match'">
        <div class="header-title">Beach Tennis Cloud ‚òÅÔ∏è</div>
        
        <button class="auth-btn" @click="toggleAuth">
            <span v-if="user" title="Admin Logado">üîì</span>
            <span v-else style="color: var(--danger);" title="Modo Leitura">üîí</span>
        </button>
    </header>

    <div class="screen" v-if="view === 'players'">
        <h3>Jogadores</h3>
        
        <div v-if="user">
            <div class="form-group">
                <input type="text" v-model="newPlayer" placeholder="Nome do Jogador" @keyup.enter="addPlayer">
            </div>
            <button class="btn btn-primary" @click="addPlayer">Adicionar Jogador</button>
        </div>
        <div v-else style="margin-bottom: 15px; font-size: 0.9rem; color: var(--text-muted);">
            Fa√ßa login para cadastrar novos jogadores.
        </div>

        <div class="player-list">
            <div style="margin-bottom: 10px; color: var(--text-muted)">Registados ({{ players.length }})</div>
            <div class="player-item" v-for="player in players" :key="player.id">
                <span>{{ player.name }}</span>
                <span v-if="user" class="btn-delete" @click="removePlayer(player)">üóëÔ∏è</span>
            </div>
        </div>
    </div>

    <div class="screen" v-if="view === 'setup'">
        <h3>Configurar Partida</h3>
        
        <div v-if="!user" class="login-placeholder">
            <div style="font-size: 3rem;">üîí</div>
            <p>Apenas administradores podem iniciar partidas.</p>
            <button class="btn btn-outline" @click="showLoginModal = true">Fazer Login</button>
        </div>

        <div v-else>
            <div class="form-group">
                <label>Games por Set</label>
                <select v-model.number="matchSetup.gamesPerSet">
                    <option value="1">1 Game (Mata-mata)</option>
                    <option value="3">3 Games (Curto)</option>
                    <option value="4">4 Games (Intermedi√°rio)</option>
                    <option value="6">6 Games (Padr√£o)</option>
                    <option value="9">9 Games (Longo)</option>
                </select>
            </div>

            <div class="form-group" style="border-left: 4px solid var(--primary); padding-left: 10px;">
                <label class="team-a-color" style="font-weight: bold;">TIME A (Laranja)</label>
                <select v-model="matchSetup.teamA1" style="margin-bottom: 10px;">
                    <option value="" disabled>Selecionar Jogador 1</option>
                    <option v-for="p in players" :value="p.name">{{ p.name }}</option>
                </select>
                <select v-model="matchSetup.teamA2">
                    <option value="" disabled>Selecionar Jogador 2</option>
                    <option v-for="p in players" :value="p.name">{{ p.name }}</option>
                </select>
            </div>

            <div class="form-group" style="border-left: 4px solid var(--secondary); padding-left: 10px; margin-top: 20px;">
                <label class="team-b-color" style="font-weight: bold;">TIME B (Turquesa)</label>
                <select v-model="matchSetup.teamB1" style="margin-bottom: 10px;">
                    <option value="" disabled>Selecionar Jogador 1</option>
                    <option v-for="p in players" :value="p.name">{{ p.name }}</option>
                </select>
                <select v-model="matchSetup.teamB2">
                    <option value="" disabled>Selecionar Jogador 2</option>
                    <option v-for="p in players" :value="p.name">{{ p.name }}</option>
                </select>
            </div>

            <button class="btn btn-primary" @click="startMatch" :disabled="!isValidSetup" style="margin-top: 20px;">
                INICIAR JOGO AGORA
            </button>
        </div>
    </div>

    <div class="screen" v-if="view === 'match'" style="padding: 10px;">
        <div class="scoreboard-container">
            <div class="match-header">
                <div class="score-box team-a-color">
                    <span class="score-label">SETS A</span>
                    <span class="score-val">{{ currentMatch.setsA }}</span>
                </div>
                <div class="score-box">
                    <span class="score-label">GAMES</span>
                    <span class="score-val">{{ currentMatch.gamesA }} - {{ currentMatch.gamesB }}</span>
                </div>
                <div class="score-box team-b-color">
                    <span class="score-label">SETS B</span>
                    <span class="score-val">{{ currentMatch.setsB }}</span>
                </div>
            </div>

            <div class="undo-bar">
                <button class="btn btn-warning" @click="undoPoint" :disabled="currentMatch.history.length === 0">
                    ‚Ü© Desfazer √öltimo Ponto
                </button>
            </div>

            <div class="points-area">
                <div class="team-column team-a-col">
                    <div class="team-names-overlay team-a-color">
                        {{ matchSetup.teamA1 }} <br> {{ matchSetup.teamA2 }}
                    </div>
                    <div class="big-point-display team-a-color">
                        {{ translateScore(currentMatch.pointsA) }}
                    </div>
                    <button class="btn-point-action btn-point-a" @click="addPoint('A')">
                        PONTO A
                    </button>
                </div>

                <div class="team-column team-b-col">
                    <div class="team-names-overlay team-b-color">
                        {{ matchSetup.teamB1 }} <br> {{ matchSetup.teamB2 }}
                    </div>
                    <div class="big-point-display team-b-color">
                        {{ translateScore(currentMatch.pointsB) }}
                    </div>
                    <button class="btn-point-action btn-point-b" @click="addPoint('B')">
                        PONTO B
                    </button>
                </div>
            </div>

            <div style="margin-top: 15px;">
                 <button class="btn btn-danger" @click="endMatchAndSave">Finalizar Partida</button>
            </div>
        </div>
    </div>

     <div class="screen" v-if="view === 'history'">
        <h3>Hist√≥rico de Partidas</h3>
        
        <button v-if="user" class="btn btn-outline" @click="showHistoryForm = !showHistoryForm" style="margin-bottom: 20px;">
            {{ showHistoryForm ? '‚ùå Cancelar Registo' : '‚ûï Registar Partida Passada' }}
        </button>

        <div v-if="showHistoryForm && user" class="manual-form">
            <h4 style="margin-top: 0; text-align: center;">Registar Manualmente</h4>
            <label class="team-a-color">Time A</label>
            <div class="score-inputs">
                <select v-model="manualMatch.teamA1" style="font-size: 0.9rem; padding: 10px; width: 48%;">
                    <option value="">Jogador 1</option>
                    <option v-for="p in players" :value="p.name">{{ p.name }}</option>
                </select>
                <select v-model="manualMatch.teamA2" style="font-size: 0.9rem; padding: 10px; width: 48%;">
                    <option value="">Jogador 2</option>
                    <option v-for="p in players" :value="p.name">{{ p.name }}</option>
                </select>
            </div>

            <label class="team-b-color" style="margin-top: 10px;">Time B</label>
            <div class="score-inputs">
                <select v-model="manualMatch.teamB1" style="font-size: 0.9rem; padding: 10px; width: 48%;">
                    <option value="">Jogador 1</option>
                    <option v-for="p in players" :value="p.name">{{ p.name }}</option>
                </select>
                <select v-model="manualMatch.teamB2" style="font-size: 0.9rem; padding: 10px; width: 48%;">
                    <option value="">Jogador 2</option>
                    <option v-for="p in players" :value="p.name">{{ p.name }}</option>
                </select>
            </div>

            <label style="margin-top: 15px; text-align: center;">Placar Final (Games)</label>
            <div class="score-inputs">
                <div class="score-input-group">
                    <small class="team-a-color">Games A</small>
                    <input type="number" v-model.number="manualMatch.gamesA" min="0" style="text-align: center;">
                </div>
                <div style="align-self: flex-end; padding-bottom: 15px; font-weight: bold; color: #555;">X</div>
                <div class="score-input-group">
                    <small class="team-b-color">Games B</small>
                    <input type="number" v-model.number="manualMatch.gamesB" min="0" style="text-align: center;">
                </div>
            </div>

            <button class="btn btn-primary" style="margin-top: 15px;" @click="saveManualMatch">Salvar no Cloud</button>
        </div>

        <div v-if="matchHistory.length === 0" style="text-align: center; color: var(--text-muted); margin-top: 20px;">
            Nenhuma partida registada.
        </div>

        <div class="history-card" v-for="match in matchHistory" :key="match.id" :class="getWinnerClass(match)">
            <div class="history-header">
                <span>üìÖ {{ formatDate(match.timestamp) }}</span>
                <span v-if="user" style="cursor: pointer;" @click="deleteHistoryItem(match.id)">üóëÔ∏è</span>
            </div>
            
            <div class="history-teams">
                <div class="team-a-color">
                    {{ match.playersA[0] }} & {{ match.playersA[1] }}
                </div>
                <div style="font-size: 0.8rem; align-self: center;">VS</div>
                <div class="team-b-color" style="text-align: right;">
                    {{ match.playersB[0] }} & {{ match.playersB[1] }}
                </div>
            </div>

            <div class="history-score-summary">
                <div>
                    <small>Sets</small>
                    <div class="history-final-score">
                        <span class="team-a-color">{{ match.finalStats.setsA }}</span>
                        -
                        <span class="team-b-color">{{ match.finalStats.setsB }}</span>
                    </div>
                </div>
                 <div>
                    <small>Games</small>
                    <div style="font-size: 1.1rem; margin-top: 5px;">
                        <span class="team-a-color">{{ match.finalStats.gamesA }}</span> - <span class="team-b-color">{{ match.finalStats.gamesB }}</span>
                    </div>
                </div>
            </div>
             <div style="text-align: center; margin-top: 10px; font-size: 0.9rem;">
                Vencedor: <strong>{{ match.winner }}</strong>
            </div>
        </div>
    </div>

    <div class="screen" v-if="view === 'stats'">
        <h3>Ranking (Firebase)</h3>
        <div v-if="computedPlayerStats.length === 0" style="text-align: center; color: var(--text-muted); margin-top: 50px;">
            Sem dados suficientes.
        </div>

        <table class="stats-table" v-else>
            <thead>
                <tr>
                    <th style="width: 40px;">#</th>
                    <th>Jogador</th>
                    <th style="text-align: center;">V</th>
                    <th style="text-align: center;">D</th>
                    <th style="text-align: right;">%</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(stat, index) in computedPlayerStats" :key="stat.name">
                    <td class="stats-rank">{{ index + 1 }}</td>
                    <td>
                        <div style="font-weight: bold;">{{ stat.name }}</div>
                        <div class="stats-win-rate">{{ stat.total }} jogos</div>
                    </td>
                    <td style="text-align: center; color: var(--success); font-weight: bold;">{{ stat.wins }}</td>
                    <td style="text-align: center; color: var(--danger);">{{ stat.losses }}</td>
                    <td style="text-align: right;">{{ stat.winRate }}%</td>
                </tr>
            </tbody>
        </table>
    </div>

    <nav class="bottom-nav" v-if="view !== 'match'">
        <div class="nav-item" :class="{active: view === 'players'}" @click="view = 'players'">
            <span class="nav-icon">üë•</span>
            <span>Jogadores</span>
        </div>
        <div class="nav-item" :class="{active: view === 'setup'}" @click="view = 'setup'">
            <span class="nav-icon">üéæ</span>
            <span>Jogar</span>
        </div>
        <div class="nav-item" :class="{active: view === 'history'}" @click="view = 'history'">
            <span class="nav-icon">üìã</span>
            <span>Hist√≥rico</span>
        </div>
        <div class="nav-item" :class="{active: view === 'stats'}" @click="view = 'stats'">
            <span class="nav-icon">üìä</span>
            <span>Ranking</span>
        </div>
    </nav>

</div>

<script>
    // --- CONFIGURA√á√ÉO DO FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyCAZ7dVN0SZE6YGkDe35MrAfQZAzbIT_gU",
        authDomain: "beach-tennis-history.firebaseapp.com",
        projectId: "beach-tennis-history",
        storageBucket: "beach-tennis-history.firebasestorage.app",
        messagingSenderId: "478079388670",
        appId: "1:478079388670:web:19fb20a80497cffc0cceaf",
        measurementId: "G-BZ0GPWERW0"
    };

    new Vue({
        el: '#app',
        data: {
            db: null,
            loading: true,
            
            // AUTH STATE
            user: null, // Objeto do usu√°rio se logado
            showLoginModal: false,
            authEmail: '',
            authPassword: '',
            showPassword: false, // Controle do olho da senha

            view: 'setup',
            newPlayer: '',
            players: [],
            matchHistory: [],
            
            showHistoryForm: false,
            manualMatch: { teamA1: '', teamA2: '', teamB1: '', teamB2: '', gamesA: 0, gamesB: 0 },
            matchSetup: { gamesPerSet: 6, teamA1: '', teamA2: '', teamB1: '', teamB2: '' },
            currentMatch: { pointsA: 0, pointsB: 0, gamesA: 0, gamesB: 0, setsA: 0, setsB: 0, history: [] }
        },
        mounted() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                this.db = firebase.firestore();
                
                // Monitora Auth
                firebase.auth().onAuthStateChanged(user => {
                    this.user = user;
                    this.loading = false;
                });

                this.listenToFirebase();
            } catch (error) {
                console.error("Config Error", error);
                this.loading = false;
            }
        },
        computed: {
            isValidSetup() {
                const s = this.matchSetup;
                const allSelected = s.teamA1 && s.teamA2 && s.teamB1 && s.teamB2;
                if (!allSelected) return false;
                const uniquePlayers = new Set([s.teamA1, s.teamA2, s.teamB1, s.teamB2]);
                return uniquePlayers.size === 4;
            },
            computedPlayerStats() {
                const stats = {};
                this.players.forEach(p => { stats[p.name] = { name: p.name, wins: 0, losses: 0, total: 0 }; });
                this.matchHistory.forEach(match => {
                    const statsA = match.finalStats;
                    let winner = null;
                    if (statsA.setsA > statsA.setsB) winner = 'A';
                    else if (statsA.setsB > statsA.setsA) winner = 'B';
                    else {
                        if (statsA.gamesA > statsA.gamesB) winner = 'A';
                        else if (statsA.gamesB > statsA.gamesA) winner = 'B';
                    }
                    if (!winner) return;

                    const processPlayer = (playerName, team) => {
                        if (!stats[playerName]) stats[playerName] = { name: playerName, wins: 0, losses: 0, total: 0 };
                        stats[playerName].total++;
                        if (winner === team) stats[playerName].wins++;
                        else stats[playerName].losses++;
                    };
                    match.playersA.forEach(p => processPlayer(p, 'A'));
                    match.playersB.forEach(p => processPlayer(p, 'B'));
                });
                return Object.values(stats)
                    .map(s => { s.winRate = s.total === 0 ? 0 : Math.round((s.wins / s.total) * 100); return s; })
                    .sort((a, b) => { if (b.wins !== a.wins) return b.wins - a.wins; return b.winRate - a.winRate; });
            }
        },
        methods: {
            // --- AUTH METHODS ---
            toggleAuth() {
                if (this.user) {
                    if(confirm("Deseja sair (Logout)?")) {
                        firebase.auth().signOut();
                        this.authPassword = ''; // Limpa senha ao sair
                        this.showPassword = false;
                    }
                } else {
                    this.showLoginModal = true;
                }
            },
            login() {
                if(!this.authEmail || !this.authPassword) return alert("Preencha e-mail e senha");
                
                this.loading = true;
                firebase.auth().signInWithEmailAndPassword(this.authEmail, this.authPassword)
                    .then(() => {
                        this.showLoginModal = false;
                        this.authPassword = ''; // Limpa senha da mem√≥ria do form
                        this.showPassword = false;
                        this.loading = false;
                    })
                    .catch(error => {
                        alert("Erro no login: " + error.message);
                        this.loading = false;
                    });
            },

            // --- FIREBASE LISTENERS ---
            listenToFirebase() {
                this.db.collection('players').orderBy('name').onSnapshot(snapshot => {
                    this.players = snapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
                });
                this.db.collection('matches').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                    this.matchHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                });
            },

            // --- DATA MANAGEMENT (PROTECTED) ---
            addPlayer() {
                if (!this.user) return alert("Fa√ßa login.");
                const name = this.newPlayer.trim();
                if (name === '') return;
                if (this.players.some(p => p.name.toLowerCase() === name.toLowerCase())) return alert('J√° existe!');

                this.loading = true;
                this.db.collection('players').add({ name: name, createdAt: new Date() })
                    .then(() => { this.newPlayer = ''; this.loading = false; })
                    .catch(err => { alert(err.message); this.loading = false; });
            },
            removePlayer(player) {
                if (!this.user) return;
                if(confirm(`Remover ${player.name}?`)) this.db.collection('players').doc(player.id).delete();
            },

            // --- GAME LOGIC ---
            startMatch() {
                this.currentMatch = { pointsA: 0, pointsB: 0, gamesA: 0, gamesB: 0, setsA: 0, setsB: 0, history: [] };
                this.view = 'match';
            },
            translateScore(val) { const s = ['0', '15', '30', '40']; return s[val] || '0'; },
            addPoint(team) {
                this.currentMatch.history.push(JSON.parse(JSON.stringify({
                    pointsA: this.currentMatch.pointsA, pointsB: this.currentMatch.pointsB,
                    gamesA: this.currentMatch.gamesA, gamesB: this.currentMatch.gamesB,
                    setsA: this.currentMatch.setsA, setsB: this.currentMatch.setsB
                })));
                if (team === 'A') this.processPoint(this.currentMatch, 'pointsA', 'pointsB', 'gamesA', 'gamesB', 'setsA');
                else this.processPoint(this.currentMatch, 'pointsB', 'pointsA', 'gamesB', 'gamesA', 'setsB');
            },
            processPoint(match, wP, lP, wG, lG, wS) {
                if (match[wP] === 3) this.winGame(match, wG, lG, wS); else match[wP]++;
            },
            winGame(match, wG, lG, wS) {
                match.pointsA = 0; match.pointsB = 0; match[wG]++;
                const t = this.matchSetup.gamesPerSet;
                if ((match[wG] === t && match[wG]-match[lG] >= 2) || match[wG] === t+1) {
                   match[wS]++; match.gamesA = 0; match.gamesB = 0;
                }
            },
            undoPoint() {
                if (this.currentMatch.history.length > 0) {
                    const l = this.currentMatch.history.pop();
                    this.currentMatch.pointsA = l.pointsA; this.currentMatch.pointsB = l.pointsB;
                    this.currentMatch.gamesA = l.gamesA; this.currentMatch.gamesB = l.gamesB;
                    this.currentMatch.setsA = l.setsA; this.currentMatch.setsB = l.setsB;
                }
            },
            formatDate(timestamp) {
                if (!timestamp) return '';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString('pt-PT', {day:'2-digit', month:'2-digit', hour: '2-digit', minute:'2-digit'});
            },
            createHistoryRecord(pA, pB, stats) {
                let wStr = 'Indefinido'; let wCls = '';
                if (stats.setsA > stats.setsB) { wStr = 'Time A (Laranja)'; wCls = 'winner-a'; }
                else if (stats.setsB > stats.setsA) { wStr = 'Time B (Turquesa)'; wCls = 'winner-b'; }
                else {
                    if (stats.gamesA > stats.gamesB) { wStr = 'Time A (Laranja)'; wCls = 'winner-a'; }
                    else if (stats.gamesB > stats.gamesA) { wStr = 'Time B (Turquesa)'; wCls = 'winner-b'; }
                }
                return {
                    timestamp: new Date(), playersA: pA, playersB: pB, finalStats: stats, winner: wStr, winnerClass: wCls
                };
            },
            endMatchAndSave() {
                if (!this.user) return alert("Fa√ßa login para salvar.");
                if(!confirm("Salvar?")) return;
                const stats = { setsA: this.currentMatch.setsA, gamesA: this.currentMatch.gamesA, setsB: this.currentMatch.setsB, gamesB: this.currentMatch.gamesB };
                const rec = this.createHistoryRecord([this.matchSetup.teamA1, this.matchSetup.teamA2], [this.matchSetup.teamB1, this.matchSetup.teamB2], stats);
                this.db.collection('matches').add(rec).then(() => { this.view = 'history'; }).catch(e => alert(e));
            },
            saveManualMatch() {
                if (!this.user) return alert("Fa√ßa login.");
                const m = this.manualMatch;
                if (!m.teamA1 || !m.teamA2 || !m.teamB1 || !m.teamB2) return alert("Selecione jogadores.");
                if (new Set([m.teamA1, m.teamA2, m.teamB1, m.teamB2]).size !== 4) return alert("Jogadores repetidos.");
                if (m.gamesA === 0 && m.gamesB === 0) return alert("Placar 0x0.");
                
                let sA = 0; let sB = 0;
                if (m.gamesA > m.gamesB) sA = 1; else if (m.gamesB > m.gamesA) sB = 1;

                const rec = this.createHistoryRecord([m.teamA1, m.teamA2], [m.teamB1, m.teamB2], { setsA: sA, gamesA: m.gamesA, setsB: sB, gamesB: m.gamesB });
                this.db.collection('matches').add(rec)
                    .then(() => { this.manualMatch = { teamA1: '', teamA2: '', teamB1: '', teamB2: '', gamesA: 0, gamesB: 0 }; this.showHistoryForm = false; })
                    .catch(e => alert(e));
            },
            getWinnerClass(match) { return match.winnerClass || ''; },
            deleteHistoryItem(docId) {
                if (!this.user) return;
                if(confirm('Apagar?')) this.db.collection('matches').doc(docId).delete();
            }
        }
    });
</script>

</body>
</html>